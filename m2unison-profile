#!/bin/bash


# Unison can connect over SSH or via a socket. SSH is used be default as there
# have been some reports of the socket mode hanging at times.
USE_SOCKET=0


PROJ=$COMPOSE_PROJECT_NAME
if [[ -z $PROJ ]]; then
    PROJ=$(basename $PWD)
fi
M2PROFILE=m2devbox-$PROJ

mkdir -p ~/.unison

LOCAL_ROOT=$(pwd)/shared/www
if [[ $USE_SOCKET == 1 ]]; then
    # Fetch the external Docker Unison port number
    SSH_ARGS_LINE=
    UNISON_PORT=$(docker-compose port unison 5000 | awk -F: '{print $2}')
    REMOTE_ROOT=socket://localhost:$UNISON_PORT//var/www
else
    SSH_PORT=$(docker-compose port unison 22 | awk -F: '{print $2}')
    echo "Testing 'ssh' connection to container..."
    ssh -p $SSH_PORT magento2@localhost echo Connection successful
    SSH_ARGS_LINE="sshargs = -p $SSH_PORT"
    REMOTE_ROOT=ssh://magento2@localhost//var/www
fi

cat << EOF > ~/.unison/$M2PROFILE.prf

# WARNING: This file is automatically generated. Changes may be over-written.

$SSH_ARGS_LINE

# Local root
root = $LOCAL_ROOT

# Remote root (Docker container)
root = $REMOTE_ROOT

# Magento files not worth pulling locally.
ignore = Path magento2/var/cache
ignore = Path magento2/var/composer_home
ignore = Path magento2/var/log
ignore = Path magento2/var/page_cache
ignore = Path magento2/var/session
ignore = Path magento2/var/tmp
ignore = Path magento2/var/.setup_cronjob_status
ignore = Path magento2/var/.update_cronjob_status

# Magento files not worth pushing remotely.
ignore = Path magento2/.git
ignore = Path magento2/.gitignore
ignore = Path magento2/.gitattributes
ignore = Path magento2/.magento
ignore = Name .idea
ignore = Name .*.swp
ignore = Name .unison.*

prefer = $LOCAL_ROOT
preferpartial = Path var -> $REMOTE_ROOT
auto = true
batch = true

EOF

echo "Unison profile '$M2PROFILE' has been created in '~/.unison'."
echo "Run 'unison -repeat watch $M2PROFILE' for file syncing mode."

